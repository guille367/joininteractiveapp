<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.js"></script>
    <script type="text/javascript" src="Scripts/jquery.BlockUI.js"></script>
</head>
<body>

    <h1>Actors</h1>

    <table class="table-hover" id="actors" border="1">
        <thead>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Bio</th>
                <th>Picture</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

    <form id="dlgActor">
        <fieldset>
            <label for="id">Id</label>
            <br />
            <input required type="text" id="id" class="form-control">
            <br />
            <label for="name">Name</label>
            <br />
            <input type="text" id="name" class="form-control">
            <br/>
            <label for="bio">Bio</label>
            <br />
            <textarea rows="5" id="bio" class="form-control"></textarea>
            <br />
            <label for="picture">picture</label>
            <br />
            <input type="text" id="picture" class="form-control">
            <br />
            <input type="submit" onclick="addActor()" class="btn btn-primary btn-block" value="Agregar"/>
            <input type="button" class="btn btn-danger btn-block" value="Cerrar"/>
        </fieldset>
    </form>

    <input type="button" id="btnAdd" value="add" class="btn btn-primary"/>
    <a href="/browse.html">Actors</a>

    <script type="text/javascript">

        $(document).ready(function () {

            $('#dlgActor').dialog({
                autoOpen: false
            });

            getActors();
        });

        $('#btnAdd').click(function () {
            $('.input').val('');
            $('#dlgActor').dialog({
                autoOpen: false
            }).dialog("open");
        });

        function addActor(actor) {
            var actor = dialogToActor();

            $("#actors").find("tbody").append(rowFromActor(actor));
            return false;
            $.ajax({
                type: 'POST',
                data: JSON.stringify(actor),
                url: '/api/actors',
                contentType: "application/json",
                success: function (data) {
                    $("#actors").find("tbody").append(rowFromActor(actor));
                },
                error: function () {
                    alert("Error al agregar actor");
                },
                complete: function () { 
                }
            });
        };

        function editActor() {
            var actor = dialogToActor();

            $.ajax({
                type: 'PUT',
                data: JSON.stringify(actor),
                url: '/api/actors',
                contentType: "application/json",
                complete: function (data) {
                    getActors();
                },
                error: function () {
                    alert("No se pudo eliminar el actor seleccionado");
                }
            });
        }

        function deleteActor(idActor) {
            $.ajax({
                url: '/api/actors/' + idActor,
                type: 'DELETE',
                contentType: "application/json",
                success: function (data) {
                    $("#actors").find("." + idActor).empty();
                },
                error: function () {
                    alert("No se pudo eliminar el actor seleccionado");
                }
            });
        };

        function loadEdit(id, name, bio, picture) {

            $('#id').attr('disabled', 'disabled').val(id);
            $('#name').val(name);
            $('#bio').val(bio);
            $('#picture').val(picture);

            $('#dlgActor').dialog({
                title: 'Edit Actor',
                buttons: {
                    "Edit": editActor,
                    Cancel: function () {
                        $("#dlgActor").dialog("close");
                    }
                }
            }).dialog('open')
        }

        function getActors() {
            $("#actors").find("tbody").empty();
            $.ajax({
                url: '/api/actors',
                type: 'GET',
                complete: function (data) {
                    loadFromData(data.responseJSON);
                }
            });
        };

        function loadFromData(data) {
            var row = $("#actors").find("tbody").append(getRowsFromData(data));
        };

        function dialogToActor() {
            var actor = {};

            actor.id = $("#id").val();
            actor.name = $("#name").val();
            actor.bio = $("#bio").val();
            actor.picture = $("#picture").val();

            return actor;
        }

        function rowFromActor(actor) {
            var str = '';
            var strEdit = actor.id + ",'" + actor.name + "','" + actor.bio + "','" + actor.picture + "'";

            str += '<tr class="' + actor.id + '">';
            str += '<td>' + actor.id + '</td>';
            str += '<td>' + actor.name + '</td>';
            str += '<td>' + actor.bio + '</td>';
            str += '<td><img src="' + actor.picture + '"></img></td>';
            str += '<td><input type="button" class="btn btn-warning" value="edit" onclick="loadEdit(' + strEdit + ')"></button></td>';
            str += '<td><input type="button" class="btn btn-danger" value="delete" onclick="deleteActor(' + actor.id + ')"></button></td>';

            str += '</tr>';
            return str;
        };

        function getRowsFromData(d) {

            var str = '';

            d.forEach(function (actor) {
                str += rowFromActor(actor);
            });

            return str;
        };

    </script>

</body>
</html>
